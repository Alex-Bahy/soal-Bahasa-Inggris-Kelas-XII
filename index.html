<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CBT - SMKN 1 Maluku Tengah</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0B3C5D; 
      --secondary: #1F77B4; 
      --accent: #F39C12; 
      --bg: #f0f2f5;
    }
    body { 
      font-family: 'Poppins', sans-serif; 
      background: var(--bg); 
      color: #1a1a1a; 
      overflow-x: hidden; 
    }
    
    .login-box { 
      max-width: 450px; 
      margin: 80px auto; 
      background: white; 
      padding: 40px; 
      border-radius: 20px; 
      box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
      border-top: 6px solid var(--accent); 
    }
    .school-logo { 
      width: 100px; 
      height: 100px;
      display: block; 
      margin: 0 auto 20px;
      object-fit: contain;
    }
    
    .header-exam { 
      background: var(--primary); 
      color: white; 
      padding: 15px 20px; 
      position: sticky; 
      top: 0; 
      z-index: 1000; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      border-bottom: 4px solid var(--accent); 
    }
    .timer-badge { 
      background: rgba(255,255,255,0.2); 
      padding: 8px 15px; 
      border-radius: 50px; 
      font-weight: bold; 
      border: 1px solid rgba(255,255,255,0.3); 
    }

    .question-card { 
      background: white; 
      padding: 30px; 
      border-radius: 16px; 
      margin: 30px auto; 
      max-width: 850px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.05); 
    }
    .option-item { 
      border: 2px solid #eef0f2; 
      border-radius: 12px; 
      padding: 15px; 
      margin-bottom: 12px; 
      cursor: pointer; 
      transition: 0.3s; 
      display: flex; 
      align-items: center; 
    }
    .option-item:hover { 
      background: #f0f7ff; 
      border-color: var(--secondary); 
    }
    .option-item.selected { 
      background: var(--primary); 
      color: white; 
      border-color: var(--primary); 
      font-weight: 600; 
    }
    
    .btn-action { 
      border-radius: 12px; 
      padding: 12px 30px; 
      font-weight: bold; 
      transition: 0.3s; 
    }
    .btn-primary { 
      background: var(--primary); 
      border: none; 
    }
    .btn-primary:hover { 
      background: var(--secondary); 
      transform: translateY(-2px); 
    }

    @media (max-width: 576px) {
      .header-title { font-size: 0.9rem; }
      #timer { font-size: 0.9rem; }
      .question-card { padding: 20px; margin: 15px; }
    }
  </style>
</head>
<body>

<div id="loginPage" class="container">
  <div class="login-box text-center">
    <img src="https://via.placeholder.com/120/0B3C5D/FFFFFF?text=SMKN1" alt="Logo SMKN 1 Malteng" class="school-logo">
    <h4 class="fw-bold mb-1">SMK NEGERI 1</h4>
    <p class="text-muted small mb-4">MALUKU TENGAH</p>
    <div class="mb-3 text-start">
      <label class="small fw-bold">Nama Lengkap Siswa</label>
      <input type="text" id="username" class="form-control p-3" placeholder="Masukkan Nama">
    </div>
    <div class="mb-4 text-start">
      <label class="small fw-bold">Password</label>
      <input type="password" id="password" class="form-control p-3" placeholder="Default: 1234">
    </div>
    <button onclick="handleLogin()" class="btn btn-primary btn-action w-100">MULAI AKSES</button>
  </div>
</div>

<div id="instructionPage" class="container d-none py-5">
  <div class="question-card">
    <h3 class="fw-bold text-center mb-4">PETUNJUK UJIAN</h3>
    <div class="alert alert-info">Halo, <strong id="studentName"></strong>. Harap baca instruksi dengan teliti!</div>
    <ul class="list-group list-group-flush mb-4">
      <li class="list-group-item">1. Waktu pengerjaan adalah <strong>45 Menit</strong>.</li>
      <li class="list-group-item">2. Dilarang <strong>Pindah Tab, Minimize, atau Membuka Aplikasi lain</strong>.</li>
      <li class="list-group-item">3. Sistem mendeteksi <strong>Split Screen</strong>. Jika dilakukan, ujian akan dianggap selesai.</li>
      <li class="list-group-item">4. Soal akan tampil satu per satu secara acak.</li>
      <li class="list-group-item">5. Hasil ujian otomatis tersimpan ke database sekolah.</li>
    </ul>
    <button onclick="startExam()" class="btn btn-primary btn-action w-100">SAYA MENGERTI, MULAI UJIAN</button>
  </div>
</div>

<div id="examPage" class="d-none">
  <div class="header-exam">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="header-title fw-bold">BAHASA INGGRIS - XII SMK</div>
      <div id="timer" class="timer-badge">45:00</div>
    </div>
  </div>
  
  <div class="container">
    <div class="question-card">
      <div id="qArea"></div>
      <div class="d-flex justify-content-between mt-4">
        <button id="btnPrev" onclick="move(-1)" class="btn btn-outline-secondary btn-action">Sebelumnya</button>
        <button id="btnNext" onclick="move(1)" class="btn btn-primary btn-action">Berikutnya</button>
      </div>
    </div>
  </div>
</div>

<div id="resultPage" class="container d-none py-5 text-center">
  <div class="question-card p-5">
    <h2 class="fw-bold text-success mb-3">UJIAN SELESAI</h2>
    <hr>
    <p class="mb-1">Nilai Akhir Anda:</p>
    <div id="finalScore" class="display-1 fw-bold mb-3" style="color: var(--primary)">0</div>
    <div id="cheatAlert" class="text-danger fw-bold mb-4"></div>
    <p class="text-muted">Data Anda telah tersimpan ke database sekolah.</p>
    <div id="uploadStatus" class="mt-3 small text-muted"></div>
  </div>
</div>

<script>
// Data Soal Bahasa Inggris Kelas XII
const questionsData = [
  { q: 'Waitress: "Would you like some more coffee, Sir?" Customer: "...., I\'ve had enough."', a: ["Yes, please", "No, thank you", "I'd love some", "Sure, that's great", "Of course"], c: 1 },
  { q: "If I ... a lot of money, I would buy a new laptop for my online class.", a: ["have", "had", "has", "having", "had had"], c: 1 },
  { q: "The new skyscraper ... by the famous architect last year.", a: ["built", "was built", "is built", "has built", "building"], c: 1 },
  { q: "What is the primary purpose of an application letter?", a: ["To describe a person's life history", "To entertain the employer with stories", "To apply for a job position in a company", "To complain about a product", "To invite someone to a meeting"], c: 2 },
  { q: 'X: "The luggage is too heavy for me." Y: "....?" X: "Yes, please. That\'s very kind of you."', a: ["Can you help me", "Would you like some help", "Do you want to buy it", "May I know your name", "Is it yours"], c: 1 },
  { q: "If the government had implemented the policy earlier, the economic crisis ... so severe.", a: ["would not be", "will not be", "would not have been", "is not", "was not"], c: 2 },
  { q: 'A: "Why is the classroom so messy?" B: "It ... since last week."', a: ["has not cleaned", "has not been cleaned", "is not cleaning", "was not clean", "is not cleaned"], c: 1 },
  { q: "In an application letter, the section that contains your contact information and the date is called ...", a: ["Salutation", "Heading", "Body of the letter", "Closing", "Signature"], c: 1 },
  { q: 'Which sentence expresses "Offering Help"?', a: ["Can you help me bring these books?", "I can't do this homework by myself.", "Shall I carry your bag for you?", "You should study harder for the exam.", "I am sorry to hear that."], c: 2 },
  { q: "Analytical Exposition texts usually use ... to explain their arguments.", a: ["Simple Past Tense", "Simple Future Tense", "Simple Present Tense", "Past Continuous Tense", "Future Perfect Tense"], c: 2 },
  { q: "Choose the correct sentence to complete a formal application letter closure.", a: ["I hope you like me.", "Thank you for considering my application.", "Please call me soon, I am waiting.", "See you later, boss.", "I am the best candidate for you."], c: 1 },
  { q: "If you study hard, you ... the national examination next month.", a: ["pass", "passed", "will pass", "would pass", "would have passed"], c: 2 },
  { q: "The students are being ... by the teacher in the laboratory now.", a: ["teach", "teaches", "taught", "teaching", "to teach"], c: 2 },
  { q: "What is the generic structure of an Analytical Exposition text?", a: ["Orientation - Complication - Resolution", "Identification - Description", "Thesis - Arguments - Reiteration", "Goal - Materials - Steps", "Newsworthy Event - Background Events - Sources"], c: 2 },
  { q: 'A: "I feel very dizzy today." B: "... you should go to the clinic immediately."', a: ["I think", "I don't think", "In my opinion is", "I would like", "Can I"], c: 0 },
  { q: "The bridge ... since the earthquake happened two years ago.", a: ["has not repaired", "is not repairing", "has not been repaired", "did not repaired", "was not repair"], c: 2 },
  { q: 'Identify the sentence that contains a "Conditional Type 3".', a: ["If it rains, I will stay at home.", "If I were you, I would take that offer.", "If they had arrived earlier, they wouldn't have missed the train.", "If you heat ice, it melts.", "I will go if you come with me."], c: 2 },
  { q: 'In a job interview, when the interviewer asks, "Why should we hire you?", they are looking for ...', a: ["Your family background", "Your weakness only", "Your strengths and how you can benefit the company", "How much salary you want", "Your hobby and interests"], c: 2 },
  { q: "Arguments in an Analytical Exposition text should be supported by ...", a: ["Personal feelings only", "Myths and legends", "Facts, statistics, or expert opinions", "Fiction stories", "Unverified rumors"], c: 2 },
  { q: 'X: "I have a terrible toothache." Y: "... you should see a dentist."', a: ["I suggest that", "I hope", "I agree that", "I don't mind", "I am sure"], c: 0 },
  { q: 'The term "Enclosure" at the bottom of an application letter indicates ...', a: ["The name of the company", "The date the letter was sent", "Other documents included with the letter (e.g., CV)", "The salary expectation", "The recipient's phone number"], c: 2 },
  { q: 'Which of the following is a characteristic of a "Thesis" in Analytical Exposition?', a: ["It summarizes the arguments.", "It gives details about the steps.", "It introduces the topic and states the writer's point of view.", "It provides evidence for the opinion.", "It ends the text with a happy ending."], c: 2 },
  { q: "If the sun didn't shine, plants ... grow.", a: ["will not", "would not", "do not", "did not", "would not have"], c: 1 },
  { q: "The report ... by the committee members when the power went out yesterday.", a: ["is being discussed", "was being discussed", "has been discussed", "was discussing", "will be discussed"], c: 1 },
  { q: 'The synonym of the word "require" in an application letter is ...', a: ["Provide", "Need", "Refuse", "Offer", "Ignore"], c: 1 }
];

// ========== KONFIGURASI GOOGLE SHEETS ==========
// GANTI URL INI DENGAN URL GOOGLE APPS SCRIPT ANDA!
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwXd38kOBosXcu48htIBVzKlieMevcbDIJGW33e5zmzrhpXmdP2edVWeYWMXH6XzwkOmw/exec";
// ===============================================

// State Management
let questions = [];
let current = 0;
let userAnswers = {};
let timerSec = 2700; // 45 menit
let isActive = false;
let student = "";
let cheatStatus = "Aman/Jujur";
let timerInterval = null;

// Login Handler
function handleLogin() {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  
  if(u && p === "1234") {
    student = u;
    document.getElementById('studentName').innerText = u;
    document.getElementById('loginPage').classList.add('d-none');
    document.getElementById('instructionPage').classList.remove('d-none');
  } else { 
    alert("Login gagal! Pastikan nama terisi dan password benar (1234)."); 
  }
}

// Start Exam
function startExam() {
  questions = [...questionsData].sort(() => Math.random() - 0.5);
  isActive = true;
  
  document.getElementById('instructionPage').classList.add('d-none');
  document.getElementById('examPage').classList.remove('d-none');
  
  renderQuestion();
  startTimer();
  initSecurity();
}

// Render Question
function renderQuestion() {
  const q = questions[current];
  let html = `<p class="text-muted small">Soal No. ${current + 1} dari ${questions.length}</p>`;
  html += `<h5 class="fw-bold mb-4">${q.q}</h5>`;
  
  q.a.forEach((opt, i) => {
    const active = userAnswers[current] === i ? 'selected' : '';
    html += `<div class="option-item ${active}" onclick="selectOpt(${i})">
              <span class="me-3 fw-bold">${String.fromCharCode(65+i)}.</span> ${opt}
             </div>`;
  });
  
  document.getElementById('qArea').innerHTML = html;
  document.getElementById('btnPrev').style.visibility = current === 0 ? 'hidden' : 'visible';
  document.getElementById('btnNext').innerText = current === questions.length - 1 ? "SELESAI" : "BERIKUTNYA";
}

// Select Option
function selectOpt(i) { 
  userAnswers[current] = i; 
  renderQuestion(); 
}

// Navigation
function move(dir) {
  if(dir === 1 && current === questions.length - 1) { 
    if(confirm("Apakah Anda yakin ingin menyelesaikan ujian?")) {
      finishExam();
    }
  } else {
    current += dir;
    if(current < 0) current = 0;
    if(current >= questions.length) current = questions.length - 1;
    renderQuestion();
  }
}

// Timer
function startTimer() {
  timerInterval = setInterval(() => {
    if(!isActive) {
      clearInterval(timerInterval);
      return;
    }
    
    let m = Math.floor(timerSec / 60);
    let s = timerSec % 60;
    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
    
    if(timerSec <= 0) { 
      clearInterval(timerInterval); 
      cheatStatus = "Waktu Habis";
      finishExam(); 
    }
    timerSec--;
  }, 1000);
}

// Security Features
function initSecurity() {
  window.onblur = function() {
    if(isActive) {
      cheatStatus = "CURANG: Pindah Tab/Aplikasi";
      finishExam();
    }
  };

  window.onresize = function() {
    if(isActive && (window.innerWidth < 450 || window.innerHeight < 450)) {
      cheatStatus = "CURANG: Deteksi Layar Terbelah/Resize";
      finishExam();
    }
  };

  document.addEventListener('contextmenu', function(e) {
    if(isActive) e.preventDefault();
  });

  document.addEventListener('keydown', function(e) {
    if(isActive) {
      if(e.key === 'F12' || 
         (e.ctrlKey && e.shiftKey && e.key === 'I') ||
         (e.ctrlKey && e.shiftKey && e.key === 'J') ||
         (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        cheatStatus = "CURANG: Mencoba Buka DevTools";
        finishExam();
      }
    }
  });
}

// Finish Exam
function finishExam() {
  if(!isActive) return;
  isActive = false;
  
  if(timerInterval) {
    clearInterval(timerInterval);
  }
  
  let correct = 0;
  questions.forEach((q, i) => {
    if(userAnswers[i] === q.c) correct++;
  });

  const score = ((correct / questions.length) * 100).toFixed(2);
  
  const result = {
    nama: student,
    skorBenar: correct,
    totalSoal: questions.length,
    nilai: score,
    statusCurang: cheatStatus,
    timestamp: new Date().toISOString()
  };
  
  // Simpan ke localStorage (backup)
  let results = JSON.parse(localStorage.getItem('examResults') || '[]');
  results.push(result);
  localStorage.setItem('examResults', JSON.stringify(results));
  
  // Kirim ke Google Sheets
  sendToGoogleSheets(result);
  
  // Tampilkan hasil
  document.getElementById('examPage').classList.add('d-none');
  document.getElementById('resultPage').classList.remove('d-none');
  document.getElementById('finalScore').innerText = score;
  
  if(cheatStatus !== "Aman/Jujur") {
    document.getElementById('cheatAlert').innerText = cheatStatus;
  }
  
  console.log('Hasil Ujian:', result);
}

// Kirim data ke Google Sheets
async function sendToGoogleSheets(data) {
  const statusEl = document.getElementById('uploadStatus');
  statusEl.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Mengirim data...';
  
  try {
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    console.log('✅ Data berhasil dikirim ke Google Sheets');
    statusEl.innerHTML = '✅ Data berhasil tersimpan ke database sekolah';
    statusEl.className = 'mt-3 small text-success';
  } catch (error) {
    console.error('❌ Gagal mengirim ke Google Sheets:', error);
    statusEl.innerHTML = '⚠️ Data tersimpan lokal, tapi gagal terkirim ke server. Hubungi admin!';
    statusEl.className = 'mt-3 small text-warning';
  }
}

// Allow Enter key for login
document.addEventListener('DOMContentLoaded', function() {
  const passwordInput = document.getElementById('password');
  if(passwordInput) {
    passwordInput.addEventListener('keypress', function(e) {
      if(e.key === 'Enter') {
        handleLogin();
      }
    });
  }
});
</script>
</body>
</html>